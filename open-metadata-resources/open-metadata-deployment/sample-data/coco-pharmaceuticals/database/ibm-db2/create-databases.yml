---
# SPDX-License-Identifier: Apache-2.0
# Copyright Contributors to the ODPi Egeria project.

- name: record database schema for future use
  set_fact:
    egeria_samples_db_schema: "{{ ibm_infosvr_users.db2inst1 | upper }}"

- name: pre-check database catalog status
  shell: >
    source ~/.bashrc &&
    db2 list database directory
  args:
    executable: /bin/bash
  become_user: "{{ ibm_infosvr_users.db2inst1 }}"
  become: yes
  ignore_errors: yes
  register: __cocopharma_db2catalog_completion
  changed_when: False
  when: ('egeria-samples-db-host' in group_names)

- name: ensure target directory exists
  file:
    path: "{{ egeria_samples_cocopharma_targets.db_location }}"
    state: directory
    mode: 0755
    owner: "{{ ibm_infosvr_users.db2inst1 }}"
    group: "{{ ibm_infosvr_groups.db2iadm1 }}"
  become: yes
  when: ('egeria-samples-db-host' in group_names)

- name: create databases
  shell: >
    source ~/.bashrc &&
    db2 create database {{ item | upper }} on '{{ egeria_samples_cocopharma_targets.db_location }}'
  args:
    executable: /bin/bash
  become: yes
  become_user: "{{ ibm_infosvr_users.db2inst1 }}"
  when: >
    __cocopharma_db2catalog_completion.stdout.find(item) == -1
    and ('egeria-samples-db-host' in group_names)
  with_items: "{{ egeria_samples_cocopharma_databases }}"

- name: post-check remote database catalog status
  shell: "source ~/.bashrc && db2 list database directory"
  args:
    executable: /bin/bash
  become_user: "{{ ibm_infosvr_users.db2inst1 }}"
  become: yes
  ignore_errors: yes
  register: __cocopharma_db2catalog_completion
  changed_when: False
  when: ('ibm-information-server-engine' in group_names)

- name: catalog remote data nodes
  shell: >
          source ~/.bashrc &&
          db2 catalog database {{ item | upper }} at node REPO &&
          db2 terminate
  args:
    executable: /bin/bash
  when: >
    ('ibm-information-server-engine' in group_names)
    and __cocopharma_db2catalog_completion.stdout.find(item) == -1
  with_items: "{{ egeria_samples_cocopharma_databases }}"
  become_user: "{{ ibm_infosvr_users.db2inst1 }}"
  become: yes
