<?xml version="1.0" encoding="UTF-8"?>

<!-- SPDX-License-Identifier: Apache-2.0 -->
<!-- Copyright Contributors to the ODPi Egeria project. -->

<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>access-services-fvt</artifactId>
        <groupId>org.odpi.egeria</groupId>
        <version>2.1-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <scm>
        <connection>scm:git:git://github.com/odpi/egeria.git</connection>
        <developerConnection>scm:git:ssh://github.com/odpi/egeria.git</developerConnection>
        <url>http://github.com/odpi/egeria/tree/master</url>
    </scm>

    <artifactId>subject-area-fvt</artifactId>
    <name>Subject Area OMAS FVT</name>
    <description>
        FVT resources for the Subject Area Open Metadata Access Service (OMAS).
    </description>

    <properties>
        <fvt.serverport>10443</fvt.serverport>
        <fvt.servername>fvtserver</fvt.servername>
        <fvt.user>garygeeke</fvt.user>
        <fvt.maxwait>10</fvt.maxwait>
        <fvt.platform-wd>../../../../open-metadata-distribution/open-metadata-assemblies/target/egeria-${open-metadata.version}-distribution/egeria-omag-${open-metadata.version}</fvt.platform-wd>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.odpi.egeria</groupId>
            <artifactId>subject-area-api</artifactId>
        </dependency>
        <dependency>
            <groupId>org.odpi.egeria</groupId>
            <artifactId>subject-area-client</artifactId>
        </dependency>
        <dependency>
            <groupId>org.odpi.egeria</groupId>
            <artifactId>open-metadata-assemblies</artifactId>
        </dependency>
    </dependencies>
    <build>
        <!--testSourceDirectory>${project.basedir}/src/main/java</testSourceDirectory-->
        <plugins>
            <!-- Integration testing -->
            <!-- start and stop of the server -->
            <plugin>
                <groupId>com.bazaarvoice.maven.plugins</groupId>
                <artifactId>process-exec-maven-plugin</artifactId>
                <executions>
                    <execution>
                        <id>chassis-start</id>
                        <phase>pre-integration-test</phase>
                        <goals>
                            <goal>start</goal>
                        </goals>
                        <configuration>
                            <name>chassis-start</name>
                            <!-- Hard coded path to locate executable . Note here we are in 'target' so it's one level further up than the clean plugin uses -->
                            <workingDir>../${fvt.platform-wd}</workingDir>
                            <waitForInterrupt>false</waitForInterrupt>
                            <!-- check doesn't support SSL, so we won't wait long-->
                            <!-- healthcheckUrl>https://localhost:${fvt.serverport}/open-metadata/platform-services/users/${fvt.user}/server-platform/origin</healthcheckUrl-->
                            <waitAfterLaunch>${fvt.maxwait}</waitAfterLaunch>
                            <processLogFile>${project.build.outputDirectory}/egeria.log</processLogFile>
                            <arguments>
                                <argument>java</argument>
                                <argument>-Dserver.port=${fvt.serverport}</argument>
                                <argument>-Dloader.path=lib</argument>
                                <argument>-jar</argument>
                                <argument>server/server-chassis-spring-${open-metadata.version}.jar</argument>
                            </arguments>
                        </configuration>
                    </execution>
                    <!--Stop all processes in reverse order-->
                    <execution>
                        <id>stop-all</id>
                        <phase>post-integration-test</phase>
                        <goals>
                            <goal>stop-all</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>

            <!-- Groovy is used to configure the server before the test -->
            <plugin>
                <groupId>org.codehaus.gmaven</groupId>
                <artifactId>groovy-maven-plugin</artifactId>
                <version>2.1.1</version>
                <executions>
                    <execution>
                        <id>server-start</id>
                        <phase>pre-integration-test</phase>
                        <goals>
                            <goal>execute</goal>
                        </goals>
                        <configuration>
                            <defaults>
                                <name>Egeria chassis</name>
                                <baseURL>https://localhost:${fvt.serverport}</baseURL>
                                <server>${fvt.servername}</server>
                                <user>${fvt.user}</user>
                            </defaults>
                                <source>${project.basedir}/src/main/script/configureStartServer.groovy</source>
                        </configuration>
                    </execution>
                </executions>
                <!-- need specific version here - pluginManagement etc not sufficient - the dependency version isn't enforced -->
                <dependencies>
                    <dependency>
                        <groupId>org.codehaus.groovy</groupId>
                        <artifactId>groovy</artifactId>
                        <version>${groovy.version}</version>
                        <classifier>indy</classifier>
                    </dependency>
                    <!--dependency>
                        <groupId>org.testng</groupId>
                        <artifactId>testng</artifactId>
                        <version>${testng.version}</version>
                    </dependency-->
                </dependencies>
            </plugin>

            <!-- failsafe is enabled in the integration test module, but we use non standard paths and filenames, so override for Subject Area -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-failsafe-plugin</artifactId>
                <executions>
                    <execution>
                        <id>local</id>
                        <phase>integration-test</phase>
                        <goals>
                            <goal>integration-test</goal>
                        </goals>
                        <configuration>
                            <!-- Our tests are actually in the java source directory -->
                            <testSourceDirectory>${project.build.sourceDirectory}</testSourceDirectory>
                            <testClassesDirectory>${project.build.outputDirectory}</testClassesDirectory>
                            <classesDirectory>${project.build.outputDirectory}</classesDirectory>
                            <includes>
                                <include>**/*.java</include>
                                <include>**/*.java</include>
                            </includes>
                            <failIfNoTests>true</failIfNoTests>
                        </configuration>
                    </execution>
                    <execution>
                        <id>verify-result</id>
                        <phase>verify</phase>
                        <goals>
                            <goal>verify</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>

            <!-- Javadoc missing from SA fvt. Skipping for now -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-javadoc-plugin</artifactId>
                <configuration>
                    <skip>true</skip>
                </configuration>
            </plugin>

            <!-- We don't make use of the assembly at a jar level, but we need it to have been created to run the integration tests -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-dependency-plugin</artifactId>
                <executions>
                    <execution>
                        <id>analyze</id>
                        <goals>
                            <goal>analyze-only</goal>
                        </goals>
                        <configuration>
                            <ignoredUnusedDeclaredDependencies combine.children="append">
                                <ignoredUnusedDeclaredDependency>
                                    org.odpi.egeria:open-metadata-assemblies:*
                                </ignoredUnusedDeclaredDependency>
                            </ignoredUnusedDeclaredDependencies>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <!-- cleanup addition files we created - including the server config file created by launching the chassis for integration testing -->
            <plugin>
                <artifactId>maven-clean-plugin</artifactId>
                <configuration>
                    <filesets>
                        <fileset>
                            <directory>${fvt.platform-wd}</directory>
                            <includes>
                                <include>*.config</include>
                                <include>*.registrystore</include>
                            </includes>
                        </fileset>
                        <fileset>
                            <directory>${basedir}/src/main/static/build</directory>
                        </fileset>
                        <fileset>
                            <directory>${basedir}/src/main/static/node_modules</directory>
                        </fileset>
                    </filesets>
                </configuration>
            </plugin>

        </plugins>

    </build>

</project>
